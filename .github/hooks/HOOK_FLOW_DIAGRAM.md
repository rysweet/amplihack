# Copilot CLI Hook Flow Diagram

Visual representation of how amplihack hooks integrate with GitHub Copilot CLI.

## Overall Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GitHub Copilot CLI                           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Parser   â”‚ â”€â”€> â”‚ Hook Manager â”‚ â”€â”€> â”‚   AI Model  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Reads configuration
                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    .github/hooks/amplihack-hooks.json           â”‚
    â”‚                                                 â”‚
    â”‚    {                                            â”‚
    â”‚      "hooks": {                                 â”‚
    â”‚        "sessionStart": [...],                   â”‚
    â”‚        "sessionEnd": [...],                     â”‚
    â”‚        "userPromptSubmitted": [...],            â”‚
    â”‚        "preToolUse": [...],                     â”‚
    â”‚        "postToolUse": [...],                    â”‚
    â”‚        "errorOccurred": [...]                   â”‚
    â”‚      }                                           â”‚
    â”‚    }                                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Invokes hooks
                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         .github/hooks/scripts/                   â”‚
    â”‚                                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚ session-start.sh â”‚  â”‚ session-end.sh   â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚user-prompt-*.sh  â”‚  â”‚pre-tool-use.sh   â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚post-tool-use.sh  â”‚  â”‚error-occurred.sh â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Creates/updates
                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          .claude/runtime/                        â”‚
    â”‚                                                 â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
    â”‚  â”‚   logs/   â”‚  â”‚ metrics/â”‚  â”‚ locks/ â”‚        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
    â”‚  â”‚  errors/  â”‚                                  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Session Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Session Start                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User launches Copilot CLI
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sessionStart Hook â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Create session directories
         â”‚   (.claude/runtime/logs/{session_id}/)
         â”‚
         â”œâ”€> Read USER_PREFERENCES.md
         â”‚   (communication style, verbosity, etc.)
         â”‚
         â”œâ”€> Inject project context
         â”‚   (DISCOVERIES.md, workflow info)
         â”‚
         â”œâ”€> Log startup metrics
         â”‚
         â””â”€> Return additionalContext to Copilot CLI
                 â”‚
                 â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Session Active   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      During Session                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User submits prompt
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ userPromptSubmitted Hookâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Log prompt to audit trail
         â”‚
         â”œâ”€> Re-inject user preferences
         â”‚   (ensures REPL continuity)
         â”‚
         â””â”€> Return additionalContext
                 â”‚
                 â–¼
         AI processes prompt
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  preToolUse Hook  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Validate tool request
         â”‚
         â”œâ”€> Check safety policies
         â”‚   (e.g., block --no-verify)
         â”‚
         â””â”€> Return {block: true/false}
                 â”‚
                 â–¼
         Tool executes (if approved)
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ postToolUse Hook  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Log tool execution
         â”‚
         â”œâ”€> Collect metrics
         â”‚   (duration, category, errors)
         â”‚
         â””â”€> Return metadata
                 â”‚
                 â–¼
         Cycle repeats...

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Session End                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User requests stop
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sessionEnd Hook  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Check lock flag
         â”‚   (.claude/runtime/locks/.lock_active)
         â”‚
         â”œâ”€> If LOCKED:
         â”‚   â””â”€> Return {decision: "block", reason: "continue work"}
         â”‚
         â””â”€> If NOT LOCKED:
             â”œâ”€> Persist session state
             â”œâ”€> Log completion metrics
             â””â”€> Return {decision: "approve"}
                     â”‚
                     â–¼
             Session ends
```

## Error Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Error Handling                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Error occurs anywhere in session
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ errorOccurred Hook  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Extract error details
         â”‚   (type, message, context, severity)
         â”‚
         â”œâ”€> Save structured error file
         â”‚   (.claude/runtime/errors/error_{timestamp}.json)
         â”‚
         â”œâ”€> Categorize error pattern
         â”‚   (timeout, permission, import, syntax, etc.)
         â”‚
         â”œâ”€> Log to error log
         â”‚
         â”œâ”€> Save error metrics
         â”‚
         â””â”€> Write to stderr for visibility
                 â”‚
                 â–¼
         Session continues (fail-safe)
```

## Lock Mode Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Lock Mode (Continuous Work)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User enables lock mode
        â”‚
        â–¼
touch .claude/runtime/locks/.lock_active
        â”‚
        â–¼
Optional: Set custom continuation prompt
echo "prompt" > .claude/runtime/locks/.continuation_prompt
        â”‚
        â–¼
Session runs normally...
        â”‚
        â–¼
User/AI requests stop
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sessionEnd Hook  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€> Detect lock flag exists
         â”‚
         â”œâ”€> Read continuation prompt
         â”‚   (custom or default)
         â”‚
         â”œâ”€> Increment lock counter
         â”‚   (.claude/runtime/locks/{session_id}/lock_invocations.txt)
         â”‚
         â””â”€> Return {decision: "block", reason: prompt}
                 â”‚
                 â–¼
         Copilot CLI continues working
                 â”‚
                 â””â”€> Repeats until lock removed
```

## Data Flow: Session Start

```
JSON Input:                          Bash Processing:                    JSON Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚                    â”‚                 â”‚                â”‚                  â”‚
â”‚ {            â”‚ â”€â”€stdinâ”€â”€>        â”‚ session-start.shâ”‚ â”€â”€stdoutâ”€â”€>   â”‚ {                â”‚
â”‚   "prompt":  â”‚                    â”‚                 â”‚                â”‚   "hookSpecific  â”‚
â”‚   "test..."  â”‚                    â”‚ â€¢ Parse JSON    â”‚                â”‚    Output": {    â”‚
â”‚ }            â”‚                    â”‚   with jq       â”‚                â”‚     "additional  â”‚
â”‚              â”‚                    â”‚                 â”‚                â”‚      Context":   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚ â€¢ Read prefs    â”‚                â”‚      "..."       â”‚
                                    â”‚   file          â”‚                â”‚   }              â”‚
                                    â”‚                 â”‚                â”‚ }                â”‚
                                    â”‚ â€¢ Build context â”‚                â”‚                  â”‚
                                    â”‚                 â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ â€¢ Format JSON   â”‚
                                    â”‚   output        â”‚
                                    â”‚                 â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow: Tool Validation

```
JSON Input:                          Bash Processing:                    JSON Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚                    â”‚                 â”‚                â”‚                  â”‚
â”‚ {            â”‚ â”€â”€stdinâ”€â”€>        â”‚ pre-tool-use.sh â”‚ â”€â”€stdoutâ”€â”€>   â”‚ {                â”‚
â”‚   "toolUse": â”‚                    â”‚                 â”‚                â”‚   "block": true, â”‚
â”‚   {          â”‚                    â”‚ â€¢ Parse tool    â”‚                â”‚   "message":     â”‚
â”‚     "name":  â”‚                    â”‚   request       â”‚                â”‚   "BLOCKED..."   â”‚
â”‚     "Bash",  â”‚                    â”‚                 â”‚                â”‚ }                â”‚
â”‚     "input": â”‚                    â”‚ â€¢ Check safety  â”‚                â”‚                  â”‚
â”‚     {        â”‚                    â”‚   policies      â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚      "cmd":  â”‚                    â”‚                 â”‚                        OR
â”‚      "git    â”‚                    â”‚ â€¢ Detect        â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      commit  â”‚                    â”‚   --no-verify   â”‚                â”‚                  â”‚
â”‚      --no-   â”‚                    â”‚                 â”‚                â”‚ {}               â”‚
â”‚      verify" â”‚                    â”‚ â€¢ Return block  â”‚                â”‚ (allow)          â”‚
â”‚     }        â”‚                    â”‚   decision      â”‚                â”‚                  â”‚
â”‚   }          â”‚                    â”‚                 â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ }            â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Directory Structure Created by Hooks

```
.claude/runtime/
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ {session_id}/              â† Created by sessionStart
â”‚       â”œâ”€â”€ session_start.log       â† Log from session-start.sh
â”‚       â”œâ”€â”€ user_prompt_submit.log  â† Log from user-prompt-submitted.sh
â”‚       â”œâ”€â”€ pre_tool_use.log        â† Log from pre-tool-use.sh
â”‚       â”œâ”€â”€ post_tool_use.log       â† Log from post-tool-use.sh
â”‚       â”œâ”€â”€ stop.log                â† Log from session-end.sh
â”‚       â”œâ”€â”€ error_occurred.log      â† Log from error-occurred.sh
â”‚       â”œâ”€â”€ prompts_audit.jsonl     â† Audit trail of all prompts
â”‚       â””â”€â”€ session_completed.txt   â† Timestamp of completion
â”œâ”€â”€ metrics/
â”‚   â”œâ”€â”€ session_start_metrics.jsonl    â† Startup metrics
â”‚   â”œâ”€â”€ user_prompt_submit_metrics.jsonl â† Prompt metrics
â”‚   â”œâ”€â”€ pre_tool_use_metrics.jsonl     â† Validation metrics
â”‚   â”œâ”€â”€ post_tool_use_metrics.jsonl    â† Tool usage metrics
â”‚   â”œâ”€â”€ stop_metrics.jsonl             â† Session end metrics
â”‚   â””â”€â”€ error_metrics.jsonl            â† Error metrics
â”œâ”€â”€ locks/
â”‚   â”œâ”€â”€ .lock_active                   â† Lock mode flag
â”‚   â”œâ”€â”€ .continuation_prompt           â† Custom prompt
â”‚   â””â”€â”€ {session_id}/
â”‚       â””â”€â”€ lock_invocations.txt       â† Lock counter
â””â”€â”€ errors/
    â””â”€â”€ error_{timestamp}.json         â† Structured error files
```

## Timing Diagram

```
Time    Event                          Hook Triggered           State Change
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T+0s    User: copilot cli              sessionStart            Session created
        Input: {}                      â†’ session-start.sh      Dirs created
                                                               Prefs loaded

T+2s    Output: context injected       -                       AI ready

T+5s    User: "implement feature"      userPromptSubmitted     Prompt logged
        Input: {userMessage}           â†’ user-prompt-*.sh      Prefs re-inject

T+6s    AI: Use Bash tool              preToolUse              Validation check
        Input: {toolUse}               â†’ pre-tool-use.sh       Safety check

T+7s    Output: approved               -                       Tool executes

T+8s    Tool: execution complete       postToolUse             Metrics saved
        Input: {result}                â†’ post-tool-use.sh      Category logged

T+10s   User: stop                     sessionEnd              Lock check
        Input: {}                      â†’ session-end.sh

T+11s   Lock NOT active                -                       Session ends
        Output: {decision: "approve"}                          State persisted
```

## Hook Chain Visualization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Complete Hook Chain                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                     sessionStart
                          â”‚
                          â”œâ”€> Initialize runtime
                          â”œâ”€> Inject preferences
                          â””â”€> Provide context
                                  â”‚
                                  â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   Session Active   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                 â”‚
              â–¼                                 â–¼
    userPromptSubmitted          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                  â”‚ Error anywhere?     â”‚
              â”‚                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚
              â”‚                         â–¼
              â”‚                  errorOccurred
              â”‚                         â”‚
              â”‚                         â””â”€> Log & categorize
              â”‚
              â”œâ”€> Log prompt
              â”œâ”€> Re-inject prefs
              â””â”€> Continue
                      â”‚
                      â–¼
              preToolUse
                      â”‚
                      â”œâ”€> Validate
                      â”œâ”€> Safety check
                      â””â”€> Block or allow
                              â”‚
                              â–¼
                      Tool executes
                              â”‚
                              â–¼
              postToolUse
                      â”‚
                      â”œâ”€> Log result
                      â”œâ”€> Collect metrics
                      â””â”€> Categorize
                              â”‚
                              â–¼
                      Cycle repeats...
                              â”‚
                              â–¼
                      sessionEnd
                              â”‚
                              â”œâ”€> Check lock
                              â”œâ”€> Block or approve
                              â””â”€> Persist state
```

---

**Legend:**

- `â”‚`, `â”œâ”€>`, `â””â”€>` : Flow direction
- `â”Œâ”€`, `â”€â”`, `â””â”€`, `â”€â”˜` : Containers/boxes
- `â–¼` : Vertical flow
- `â”€â”€>` : Data/control flow
- `{...}` : JSON data
- `.sh` : Bash scripts

**Arrr, now ye can see the whole treasure map! âš“ğŸ—ºï¸**
