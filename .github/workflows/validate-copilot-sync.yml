name: Validate Copilot CLI Sync

on:
  pull_request:
    paths:
      - '.claude/commands/**'
      - '.github/commands/**'
  push:
    branches:
      - main
    paths:
      - '.claude/commands/**'
      - '.github/commands/**'

jobs:
  check-sync:
    runs-on: ubuntu-latest
    name: Verify commands are synced

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install amplihack
        run: |
          pip install -e .

      - name: Check if commands are in sync
        run: |
          # Run sync in dry-run mode to check if any files would change
          python << 'EOF'
          from pathlib import Path
          from src.amplihack.adapters.copilot_command_converter import is_commands_synced

          source = Path(".claude/commands")
          target = Path(".github/commands")

          if not target.exists():
              print("⚠️  .github/commands/ doesn't exist yet - first time setup")
              exit(0)

          if is_commands_synced(source, target):
              print("✅ Commands are in sync")
              exit(0)
          else:
              print("❌ Commands are OUT OF SYNC!")
              print("")
              print("The .claude/commands/ files have been modified but .github/commands/")
              print("was not regenerated.")
              print("")
              print("Fix: Run 'amplihack sync-commands' locally")
              print("Or: Let pre-commit hook auto-sync (run 'pre-commit install')")
              exit(1)
          EOF

      - name: Report sync status
        if: failure()
        run: |
          echo "::error::Commands are out of sync. Run 'amplihack sync-commands' to fix."
