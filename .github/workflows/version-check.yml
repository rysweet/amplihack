# Version Bump Check
# Ensures that all PRs to main branch bump the version in pyproject.toml
# This prevents merging code without updating the version number

name: Version Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-version-bump:
    name: Check Version Bump
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          # Fetch full history so we can compare with main branch
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch main branch
        run: |
          git fetch origin main:main

      - name: Check version bump
        run: |
          echo "Checking if version was bumped in pyproject.toml..."
          python scripts/check_version_bump.py

      - name: Success message
        if: success()
        run: |
          echo "✅ Version check passed!"
          echo ""
          echo "The version in pyproject.toml has been properly bumped."
          echo "This PR is ready for review and merge."

      - name: Failure instructions
        if: failure()
        run: |
          echo ""
          echo "ℹ️  How to fix this:"
          echo "   1. Edit pyproject.toml and bump the version on line 8"
          echo "   2. Choose the appropriate version bump type:"
          echo "      - Patch (bug fixes): 0.2.0 → 0.2.1"
          echo "      - Minor (new features): 0.2.0 → 0.3.0"
          echo "      - Major (breaking changes): 0.2.0 → 1.0.0"
          echo "   3. Commit and push the change"
          echo ""
          exit 1
