name: PM - Daily Status Report

# Purpose: Generate daily project status report and post to tracking issue
# Security: Implements all 9 mandatory mitigations from SECURITY_ASSESSMENT.md
# Type: Informational only (read-only, no state changes)

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch: # Allow manual triggering for testing

# SECURITY M2.1: Minimal permissions (read-only by default)
permissions:
  contents: read # Read repository contents only
  issues: write # Post status reports to designated issue

jobs:
  daily-status:
    name: Generate Daily Status
    runs-on: ubuntu-latest
    # SECURITY: Timeout limit prevents runaway execution
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -e .

      # SECURITY M3.2: Use environment variables, never string interpolation
      # SECURITY: Error handling filters output to prevent secret leakage
      - name: Generate status report
        id: status
        env:
          ISSUE_NUMBER: ${{ vars.PM_STATUS_ISSUE_NUMBER }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +x  # Disable command echoing to prevent accidental exposure

          # NOTE M3.1: PM scripts must sanitize user inputs
          # NOTE M3.4: PM scripts must validate for prompt injection

          # Generate status report using PM daily status script
          python .github/scripts/pm_daily_status.py

          # Add summary to GitHub Actions step summary
          cat status_report.md >> $GITHUB_STEP_SUMMARY

      - name: Post report to tracking issue
        uses: peter-evans/create-or-update-comment@v4
        if: success() && vars.PM_STATUS_ISSUE_NUMBER != ''
        with:
          issue-number: ${{ vars.PM_STATUS_ISSUE_NUMBER }}
          body-path: status_report.md

      # SECURITY: Error handling without exposing secrets
      - name: Handle errors
        if: failure()
        run: |
          echo "::error::Daily status workflow failed. Check logs for details."
          echo "Note: Check that ANTHROPIC_API_KEY secret and PM_STATUS_ISSUE_NUMBER variable are configured."
