# Auto-Mode Workflow Recipe
# Enables autonomous multi-turn execution until task completion
#
# This is the Amplifier equivalent of `amplihack claude --auto --max-turns N`
# It uses lock mode + structured execution to achieve continuous work.
#
# Usage:
#   recipes(operation="execute", recipe_path="amplihack:recipes/auto-workflow.yaml",
#           context={"task": "Implement user authentication"})

name: "auto-workflow"
description: "Autonomous multi-turn workflow - continues until task complete or max iterations"
version: "1.0.0"
author: "Amplihack Team"
tags: ["autonomous", "continuous", "multi-turn", "auto-mode"]

recursion:
  max_depth: 3
  max_total_steps: 20

context:
  task: ""
  max_iterations: 5
  success_criteria: "Task is fully implemented and tested"
  repo_path: "."

steps:
  # Step 1: Enable lock mode for continuous work
  - id: "enable-lock-mode"
    type: "bash"
    command: |
      cd "{{repo_path}}"
      mkdir -p .claude/runtime/locks
      echo "$(date -Iseconds)" > .claude/runtime/locks/.lock_active
      echo "Auto-mode: {{task}}" | head -c 100 > .claude/runtime/locks/.lock_message
      echo "Lock mode enabled for auto-workflow"
    output: "lock_status"

  # Step 2: Plan the work
  - id: "plan-task"
    type: "agent"
    agent: "foundation:zen-architect"
    prompt: |
      Create a detailed execution plan for this task:

      **Task**: {{task}}

      **Success Criteria**: {{success_criteria}}

      Provide:
      1. A numbered list of concrete steps (max 10)
      2. Dependencies between steps
      3. Definition of "done" for the overall task

      Be specific and actionable. Keep the plan focused.
    output: "plan"

  # Step 3: Execute iteration 1
  - id: "execute-iteration-1"
    type: "agent"
    agent: "foundation:modular-builder"
    prompt: |
      **AUTONOMOUS EXECUTION MODE**

      You are in auto-mode. Work continuously until the task is complete.

      **Task**: {{task}}

      **Plan**:
      {{plan}}

      **Instructions**:
      1. Start with the first uncompleted step
      2. Implement fully (no placeholders)
      3. Run tests if applicable
      4. End with "STATUS: CONTINUE" if more work remains
      5. End with "STATUS: COMPLETE" if task is done

      **Iteration**: 1 of {{max_iterations}}
    output: "iteration_1"

  # Step 4: Execute iteration 2 (conditional)
  - id: "execute-iteration-2"
    type: "agent"
    condition: "'CONTINUE' in iteration_1"
    agent: "foundation:modular-builder"
    prompt: |
      **AUTONOMOUS EXECUTION - CONTINUING**

      **Task**: {{task}}

      **Previous Work**: {{iteration_1}}

      Continue from where you left off.
      End with "STATUS: CONTINUE" or "STATUS: COMPLETE"

      **Iteration**: 2 of {{max_iterations}}
    output: "iteration_2"

  # Step 5: Execute iteration 3 (conditional)
  - id: "execute-iteration-3"
    type: "agent"
    condition: "iteration_2 is defined and 'CONTINUE' in iteration_2"
    agent: "foundation:modular-builder"
    prompt: |
      **AUTONOMOUS EXECUTION - CONTINUING**

      **Task**: {{task}}

      Continue working. Iteration 3 of {{max_iterations}}.
      End with "STATUS: CONTINUE" or "STATUS: COMPLETE"
    output: "iteration_3"

  # Step 6: Execute iteration 4 (conditional)
  - id: "execute-iteration-4"
    type: "agent"
    condition: "iteration_3 is defined and 'CONTINUE' in iteration_3"
    agent: "foundation:modular-builder"
    prompt: |
      **AUTONOMOUS EXECUTION - CONTINUING**

      **Task**: {{task}}

      Continue working. Iteration 4 of {{max_iterations}}.
      End with "STATUS: CONTINUE" or "STATUS: COMPLETE"
    output: "iteration_4"

  # Step 7: Execute iteration 5 (conditional - final)
  - id: "execute-iteration-5"
    type: "agent"
    condition: "iteration_4 is defined and 'CONTINUE' in iteration_4"
    agent: "foundation:modular-builder"
    prompt: |
      **AUTONOMOUS EXECUTION - FINAL ITERATION**

      **Task**: {{task}}

      This is the FINAL iteration. Complete as much as possible.
      Summarize what was completed and what remains.
    output: "iteration_5"

  # Step 8: Disable lock mode
  - id: "disable-lock-mode"
    type: "bash"
    command: |
      cd "{{repo_path}}"
      rm -f .claude/runtime/locks/.lock_active
      rm -f .claude/runtime/locks/.lock_message
      echo "Lock mode disabled"
    output: "unlock_status"

  # Step 9: Generate summary
  - id: "generate-summary"
    type: "agent"
    agent: "foundation:zen-architect"
    prompt: |
      Generate a summary of the auto-mode execution:

      **Task**: {{task}}

      **Results**:
      - Iteration 1: {{iteration_1}}
      {% if iteration_2 is defined %}- Iteration 2: {{iteration_2}}{% endif %}
      {% if iteration_3 is defined %}- Iteration 3: {{iteration_3}}{% endif %}
      {% if iteration_4 is defined %}- Iteration 4: {{iteration_4}}{% endif %}
      {% if iteration_5 is defined %}- Iteration 5: {{iteration_5}}{% endif %}

      Provide:
      1. **Summary**: What was accomplished
      2. **Status**: COMPLETE or INCOMPLETE
      3. **Next Steps**: If incomplete, what remains
    output: "final_summary"

output:
  format: "markdown"
  template: |
    # Auto-Mode Execution Complete

    **Task**: {{task}}

    ## Summary

    {{final_summary}}

    ---
    *Executed via amplihack auto-workflow recipe*
