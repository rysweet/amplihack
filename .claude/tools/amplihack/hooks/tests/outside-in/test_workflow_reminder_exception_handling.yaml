scenario:
  name: "Workflow Classification Reminder - Exception Handling Outside-In Tests"
  description: |
    Verifies that workflow_classification_reminder:
    1. Handles corrupt state file gracefully (new: logs to DEBUG instead of silent pass)
    2. Returns a valid additionalContext response for new topics
    3. Returns empty {} for follow-ups
    4. Does NOT crash when state file is unreadable

    Specifically tests the exception path in is_new_topic() where state file JSON
    is corrupt - previously silently passed, now logs "Could not read classification
    state (using default)".
  type: cli
  tags: [hooks, workflow-reminder, exception-handling, outside-in]

  prerequisites:
    - "Python 3.11+ available"
    - "Hook at .claude/tools/amplihack/hooks/workflow_classification_reminder.py exists"

  steps:
    # Test 1: Happy path - new topic on first turn
    - action: launch
      target: "python"
      args: [".claude/tools/amplihack/hooks/workflow_classification_reminder.py"]
      description: "First turn - should inject classification reminder"
      environment:
        CLAUDE_SESSION_ID: "test-exception-session-001"

    - action: send_input
      value: |
        {"userMessage": "Implement JWT authentication", "turnCount": 0}

    - action: verify_output
      contains: "additionalContext"
      stream: stdout
      description: "Must return additionalContext JSON field for new topics"
      timeout: 5s

    - action: verify_output
      contains: "system-reminder"
      stream: stdout
      description: "additionalContext must contain system-reminder XML"

    - action: verify_exit_code
      expected: 0

    # Test 2: Happy path - follow-up should return empty object
    - action: launch
      target: "python"
      args: [".claude/tools/amplihack/hooks/workflow_classification_reminder.py"]
      description: "Follow-up turn (turnCount=2, within 3 of last classification)"
      environment:
        CLAUDE_SESSION_ID: "test-exception-session-001"

    - action: send_input
      value: |
        {"userMessage": "Also add refresh token support", "turnCount": 2}

    - action: verify_output
      matches: '^\s*\{\s*\}\s*$'
      stream: stdout
      description: "Follow-up should return empty JSON object"
      timeout: 5s

    - action: verify_exit_code
      expected: 0

    # Test 3: Corrupt state file - should log error and treat as new topic
    - action: launch
      target: "python"
      args:
        - "-c"
        - |
          import sys, os, json, tempfile, subprocess

          with tempfile.TemporaryDirectory() as tmpdir:
              # Create a corrupt state file in expected location
              session_id = "corrupt-state-test"
              state_dir = os.path.join(tmpdir, '.claude', 'runtime', 'logs', session_id)
              os.makedirs(state_dir, exist_ok=True)

              state_file = os.path.join(state_dir, 'classification_state.json')
              with open(state_file, 'w') as f:
                  f.write('NOT VALID JSON {{{ corrupt content')

              env = os.environ.copy()
              env['CLAUDE_SESSION_ID'] = session_id
              env['CLAUDE_PROJECT_DIR'] = tmpdir

              inp = json.dumps({
                  "userMessage": "Fix the bug in auth",
                  "turnCount": 5  # Non-zero, will try to read state file
              })

              result = subprocess.run(
                  [sys.executable, '.claude/tools/amplihack/hooks/workflow_classification_reminder.py'],
                  input=inp, capture_output=True, text=True, env=env,
                  cwd='/home/azureuser/src/amplihack4'
              )
              print(result.stdout, end='')
              print(result.stderr, end='', file=sys.stderr)
              sys.exit(result.returncode)
      description: "Corrupt state file should log error and fall back to new-topic detection"

    - action: verify_exit_code
      expected: 0
      description: "Must not crash on corrupt state file"
      timeout: 10s

    - action: verify_output
      matches: '^\s*\{.*\}\s*$'
      stream: stdout
      description: "Must still produce valid JSON output despite corrupt state"

    # Test 4: Completely invalid JSON stdin - graceful error handling
    - action: launch
      target: "python"
      args: [".claude/tools/amplihack/hooks/workflow_classification_reminder.py"]
      description: "Invalid JSON stdin - hook must not crash"
      environment:
        CLAUDE_SESSION_ID: "test-invalid-json"

    - action: send_input
      value: "COMPLETELY_INVALID"

    - action: verify_exit_code
      expected: 0
      description: "Hook must exit 0 even on malformed input"
      timeout: 5s

  cleanup:
    - description: "State files created in temp dirs are cleaned up by context managers"
