version: '3.8'

# CI-optimized shadow environment
# Usage:
#   In GitHub Actions or other CI:
#   1. Create bundle in CI: git bundle create snapshot.bundle --all
#   2. Run: docker-compose -f docker-compose/ci-shadow.yml run --rm ci-test
#   3. Check exit code for pass/fail

services:
  ci-shadow:
    image: ghcr.io/microsoft/amplifier-shadow:latest
    container_name: ci-shadow
    volumes:
      # CI creates bundle from current commit
      - ./snapshot.bundle:/snapshots/repo.bundle:ro
      # Results directory for artifacts
      - ./test-results:/test-results
    environment:
      # CI environment markers
      - CI=true
      - GITHUB_ACTIONS=${GITHUB_ACTIONS:-false}
      # Cache isolation
      - UV_NO_GITHUB_FAST_PATH=1
      - UV_CACHE_DIR=/tmp/uv-cache
    # Run tests and exit with status code
    command: >
      bash -c "
        set -e

        echo '==> Starting Gitea' &&
        /usr/local/bin/docker-entrypoint.sh &
        sleep 5 &&

        echo '==> Waiting for Gitea' &&
        until curl -sf http://localhost:3000/api/v1/version > /dev/null; do
          sleep 1
        done &&

        echo '==> Setting up repository' &&
        ORG=\${REPO_ORG:-myorg}
        REPO=\${REPO_NAME:-my-repo}

        curl -s -u shadow:shadow -H 'Content-Type: application/json' \
          -d \"{\\\"username\\\":\\\"\$ORG\\\"}\" \
          http://localhost:3000/api/v1/orgs &&
        curl -s -u shadow:shadow -H 'Content-Type: application/json' \
          -d \"{\\\"name\\\":\\\"\$REPO\\\",\\\"private\\\":false}\" \
          http://localhost:3000/api/v1/orgs/\$ORG/repos &&

        cd /tmp && rm -rf _push && mkdir _push && cd _push &&
        git init --bare --quiet &&
        git bundle list-heads /snapshots/repo.bundle | while read sha ref; do
          branch_name=\$(echo \"\$ref\" | sed 's|refs/heads/||; s|refs/remotes/origin/|_upstream_|')
          if echo \"\$ref\" | grep -q \"HEAD\"; then continue; fi
          git fetch /snapshots/repo.bundle \"\$ref:refs/heads/\$branch_name\" 2>/dev/null || true
        done &&
        git remote add origin http://shadow:shadow@localhost:3000/\$ORG/\$REPO.git &&
        git push origin --all --force 2>&1 | grep -v 'remote:' &&

        echo '==> Configuring git' &&
        git config --global url.\"http://shadow:shadow@localhost:3000/\$ORG/\$REPO.git\".insteadOf \"https://github.com/\$ORG/\$REPO.git\" &&

        echo '==> Cloning to workspace' &&
        git clone http://shadow:shadow@localhost:3000/\$ORG/\$REPO.git /workspace/repo --quiet 2>&1 &&
        cd /workspace/repo &&

        echo '==> Running tests' &&
        if [ -f './scripts/ci-test.sh' ]; then
          ./scripts/ci-test.sh
        elif [ -f 'pytest.ini' ] || [ -f 'pyproject.toml' ]; then
          uv venv && . .venv/bin/activate && uv pip install -e '.[dev]' && pytest
        elif [ -f 'package.json' ]; then
          npm install && npm test
        elif [ -f 'Cargo.toml' ]; then
          cargo test
        else
          echo 'No test configuration found'
          exit 1
        fi &&

        echo '==> Tests passed!' &&
        exit 0
      "
