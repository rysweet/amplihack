name: "investigation-workflow"
description: "6-phase systematic investigation workflow with parallel agent deployment for understanding code, systems, and behavior"
version: "2.0.0"
author: "Amplihack Team"
tags: ["investigation", "exploration", "understanding", "analysis", "research", "parallel"]

# INVESTIGATION_WORKFLOW: Systematic Investigation with Parallel Execution
#
# EXACT PARITY with .claude/workflow/INVESTIGATION_WORKFLOW.md
#
# Use this workflow for tasks involving:
#   - "investigate", "explain", "understand", "how does", "why does"
#   - "analyze", "research", "explore", "examine", "study"
#
# NOT for development tasks - use default-workflow for "implement", "build", "create", "add feature"
#
# 6 Phases:
#   1. Scope Definition - Define boundaries and success criteria (prompt-writer, ambiguity)
#   2. Exploration Strategy - Plan agent deployment with selection guidelines (architect, patterns)
#   3. Parallel Deep Dives - CRITICAL: Deploy multiple agents SIMULTANEOUSLY
#   4. Verification - Hypothesis-based testing with practical verification
#   5. Synthesis - Generate 5 outputs: executive, detailed, visual, insights, unknowns
#   6. Knowledge Capture - Update DISCOVERIES.md and PATTERNS.md
#
# Agent Selection Guidelines (Phase 2 determines Phase 3 agents):
#   - Code investigation: analyzer + patterns
#   - Architecture investigation: architect + api-designer
#   - Performance investigation: optimizer + analyzer
#   - Security investigation: security + patterns
#   - Integration investigation: integration + database
#
# Efficiency Target: 30-40% message reduction vs ad-hoc investigation
#
# Usage:
#   amplifier recipes execute investigation-workflow.yaml --context '{
#     "investigation_question": "How does the authentication system work?",
#     "codebase_path": "src/auth",
#     "investigation_type": "code",
#     "depth": "deep"
#   }'

recursion:
  max_depth: 6
  max_total_steps: 60

context:
  # The main question to investigate
  investigation_question: ""

  # Path to focus investigation on (optional)
  codebase_path: ""

  # Investigation type determines agent selection:
  # - code: analyzer + patterns (default)
  # - architecture: architect + api-designer
  # - performance: optimizer + analyzer
  # - security: security + patterns
  # - integration: integration + database
  investigation_type: "code"

  # Investigation depth: surface, standard, deep
  depth: "standard"

  # Output directory for findings
  output_dir: "./ai_working/investigation"

  # Knowledge file paths
  discoveries_path: ".claude/context/DISCOVERIES.md"
  patterns_path: ".claude/context/PATTERNS.md"

  # Efficiency tracking (internal)
  _start_time: ""
  _message_count: 0

steps:
  # ==========================================================================
  # INITIALIZATION: Track start time for efficiency metrics
  # ==========================================================================
  - id: "init-tracking"
    type: "bash"
    command: |
      echo "{\"start_time\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"message_count\": 1}"
    output: "tracking"
    parse_json: true

  # ==========================================================================
  # PHASE 1: SCOPE DEFINITION
  # Define investigation boundaries and success criteria
  # Uses: prompt-writer (scope), ambiguity (if needed)
  # ==========================================================================
  - id: "scope-definition"
    agent: "amplihack:prompt-writer"
    prompt: |
      Define the scope for this investigation task.

      **Investigation Question:** {{investigation_question}}
      **Codebase Focus:** {{codebase_path}}
      **Investigation Type:** {{investigation_type}}
      **Depth:** {{depth}}

      ## Your Task

      1. **Identify explicit user requirements** - What specific questions must be answered?
      2. **Define what counts as "understanding achieved"**
      3. **List specific questions that must be answered**
      4. **Identify known unknowns** (what we know we don't know)
      5. **Set boundaries** - What's in scope vs. out of scope
      6. **Estimate investigation depth needed** (surface-level vs. deep dive)

      ## Agent Selection Guidelines

      Based on the investigation type, recommend agents for Phase 3:
      - **Code investigation:** analyzer + patterns
      - **Architecture investigation:** architect + api-designer
      - **Performance investigation:** optimizer + analyzer
      - **Security investigation:** security + patterns
      - **Integration investigation:** integration + database

      Provide scope definition as JSON:
      ```json
      {
        "core_questions": ["list of specific questions to answer"],
        "success_criteria": ["measurable criteria - e.g., 'can explain system flow', 'can diagram architecture'"],
        "in_scope": ["what's included in this investigation"],
        "out_of_scope": ["what's explicitly excluded"],
        "known_unknowns": ["what we know we don't know"],
        "estimated_complexity": "low|medium|high",
        "estimated_depth": "surface|standard|deep",
        "has_ambiguities": true|false,
        "ambiguities": ["list of unclear aspects if any"],
        "recommended_agents": {
          "primary": "amplihack:analyzer",
          "secondary": "amplihack:patterns",
          "tertiary": "amplihack:architect",
          "specialist": null
        }
      }
      ```

      Be specific and measurable in success criteria.
    output: "scope"
    parse_json: true

  - id: "clarify-ambiguities"
    agent: "amplihack:ambiguity"
    condition: "{{scope.has_ambiguities}}"
    prompt: |
      The scope definition identified ambiguities that need clarification.

      **Original Question:** {{investigation_question}}
      **Identified Ambiguities:** {{scope.ambiguities}}

      ## Your Task

      For each ambiguity:
      1. Analyze what makes it unclear
      2. Propose reasonable interpretations
      3. Recommend the most likely intended meaning
      4. Flag any that require user clarification

      Provide clarifications as JSON:
      ```json
      {
        "clarified_ambiguities": [
          {
            "original": "the ambiguous aspect",
            "interpretation": "our interpretation",
            "confidence": "high|medium|low",
            "requires_user_input": false
          }
        ],
        "updated_core_questions": ["refined questions incorporating clarifications"],
        "blockers": ["any ambiguities that absolutely require user input"]
      }
      ```
    output: "ambiguity_resolution"
    parse_json: true

  # ==========================================================================
  # PHASE 2: EXPLORATION STRATEGY
  # Plan which agents to deploy and what to investigate
  # Uses: architect (strategy), patterns (past investigations), knowledge-archaeologist (history)
  # ==========================================================================
  - id: "exploration-strategy"
    agent: "amplihack:architect"
    prompt: |
      Design an exploration strategy for this investigation.

      **Investigation Question:** {{investigation_question}}
      **Investigation Type:** {{investigation_type}}
      **Scope:** {{scope}}
      **Ambiguity Resolution:** {{ambiguity_resolution}}

      ## Agent Selection Guidelines (CRITICAL)

      Select agents based on investigation type:
      - **Code investigation:** amplihack:analyzer + amplihack:patterns
      - **Architecture investigation:** amplihack:architect + amplihack:api-designer
      - **Performance investigation:** amplihack:optimizer + amplihack:analyzer
      - **Security investigation:** amplihack:security + amplihack:patterns
      - **Integration investigation:** amplihack:integration + amplihack:database

      Additional agents as needed:
      - amplihack:knowledge-archaeologist (for historical context)
      - amplihack:reviewer (for validation)

      ## Your Task

      1. **Identify key areas to explore** (code paths, configurations, documentation)
      2. **Select specialized agents for parallel deployment in Phase 3**
      3. **Create investigation roadmap with priorities**
      4. **Identify potential dead ends to avoid**
      5. **Plan verification approach** (how to test understanding)

      Create an exploration plan as JSON:
      ```json
      {
        "exploration_areas": [
          {
            "area": "area name",
            "agent": "amplihack:agent-name",
            "focus": "specific focus for this agent",
            "expected_output": "what we expect to learn",
            "priority": 1
          }
        ],
        "parallel_deployment": {
          "primary_agent": "amplihack:analyzer",
          "primary_focus": "specific focus area",
          "secondary_agent": "amplihack:patterns",
          "secondary_focus": "specific focus area",
          "tertiary_agent": "amplihack:architect",
          "tertiary_focus": "specific focus area",
          "specialist_agent": null,
          "specialist_focus": null
        },
        "priority_order": ["ordered list of exploration areas"],
        "potential_dead_ends": ["areas to avoid or deprioritize"],
        "verification_approach": "how to test and validate understanding",
        "historical_context_needed": true|false
      }
      ```
    output: "strategy"
    parse_json: true

  - id: "check-past-investigations"
    agent: "amplihack:patterns"
    prompt: |
      Check for similar past investigations and reusable patterns.

      **Investigation Question:** {{investigation_question}}
      **Strategy:** {{strategy}}

      ## Your Task

      1. Search for similar investigations in DISCOVERIES.md
      2. Check PATTERNS.md for relevant patterns
      3. Identify reusable knowledge that can accelerate this investigation
      4. Note any related documentation that might help

      Provide findings as JSON:
      ```json
      {
        "related_discoveries": [
          {
            "title": "discovery title",
            "relevance": "how it relates",
            "key_insight": "what we can reuse"
          }
        ],
        "applicable_patterns": [
          {
            "pattern": "pattern name",
            "applicability": "how to apply it here"
          }
        ],
        "suggested_starting_points": ["files or areas to start with"],
        "warnings": ["pitfalls from past investigations"]
      }
      ```
    output: "past_investigations"
    parse_json: true

  - id: "historical-research"
    agent: "amplihack:knowledge-archaeologist"
    condition: "{{strategy.historical_context_needed}}"
    prompt: |
      Research historical context for this investigation.

      **Investigation Question:** {{investigation_question}}
      **Strategy:** {{strategy}}

      ## Your Task

      1. Examine git history for relevant changes
      2. Find original design decisions and their rationale
      3. Identify evolution of the system over time
      4. Note any deprecated approaches or migrations

      Provide historical context as JSON:
      ```json
      {
        "historical_timeline": [
          {
            "period": "description",
            "key_changes": ["changes"],
            "rationale": "why"
          }
        ],
        "original_design_decisions": ["key decisions and their reasons"],
        "evolution_notes": ["how the system evolved"],
        "deprecated_approaches": ["things that no longer apply"]
      }
      ```
    output: "historical_context"
    parse_json: true

  # ==========================================================================
  # PHASE 3: DEEP DIVES
  # Deploy multiple exploration agents for comprehensive investigation
  # Uses: analyzer (primary), patterns (secondary), architect (tertiary)
  # ==========================================================================
  - id: "deep-dive-primary"
    agent: "amplihack:analyzer"
    prompt: |
      Conduct a deep dive exploration as the PRIMARY investigator.

      **Investigation Question:** {{investigation_question}}
      **Your Focus:** {{strategy.parallel_deployment.primary_focus}}
      **Codebase Path:** {{codebase_path}}
      **Strategy:** {{strategy}}
      **Past Investigations:** {{past_investigations}}
      **Historical Context:** {{historical_context}}

      ## Your Task (Primary Investigation)

      1. **Map the relevant code structure** in your focus area
      2. **Identify key files, functions, and classes**
      3. **Trace data flows and dependencies**
      4. **Note patterns, anomalies, and unexpected behaviors**
      5. **Document code paths with file:line references**

      Provide findings in a structured format:
      - File paths and line numbers for key discoveries
      - Code snippets for important sections
      - Dependency relationships
      - Open questions that emerged
      - Connections to other areas (for synthesis)
    output: "primary_findings"

  - id: "deep-dive-secondary"
    agent: "amplihack:patterns"
    prompt: |
      Conduct a deep dive exploration as the SECONDARY investigator.

      **Investigation Question:** {{investigation_question}}
      **Your Focus:** {{strategy.parallel_deployment.secondary_focus}}
      **Codebase Path:** {{codebase_path}}
      **Strategy:** {{strategy}}
      **Past Investigations:** {{past_investigations}}

      ## Your Task (Secondary Investigation)

      1. **Explore your assigned focus area thoroughly**
      2. **Identify patterns and anti-patterns**
      3. **Look for connections to other system components**
      4. **Note design decisions and their implications**
      5. **Document findings with evidence**

      Provide findings focusing on:
      - Patterns discovered
      - Design rationale observed
      - Integration points
      - Potential concerns or improvements
      - Questions for verification phase
    output: "secondary_findings"

  - id: "deep-dive-tertiary"
    agent: "amplihack:architect"
    prompt: |
      Conduct a deep dive exploration as the TERTIARY investigator.

      **Investigation Question:** {{investigation_question}}
      **Your Focus:** {{strategy.parallel_deployment.tertiary_focus}}
      **Codebase Path:** {{codebase_path}}
      **Strategy:** {{strategy}}

      ## Your Task (Tertiary Investigation)

      1. **Analyze architectural aspects** in your focus area
      2. **Examine component boundaries and responsibilities**
      3. **Identify integration points and interfaces**
      4. **Assess design quality and potential issues**
      5. **Document structural insights**

      Provide findings focusing on:
      - Architectural observations
      - Component interactions
      - Interface analysis
      - Structural concerns
      - Recommendations for understanding
    output: "tertiary_findings"

  - id: "deep-dive-specialist"
    agent: "amplihack:security"
    condition: "{{strategy.parallel_deployment.specialist_agent}}"
    prompt: |
      Conduct a SPECIALIST deep dive for this investigation.

      **Investigation Question:** {{investigation_question}}
      **Your Specialty Focus:** {{strategy.parallel_deployment.specialist_focus}}
      **Codebase Path:** {{codebase_path}}
      **Strategy:** {{strategy}}

      ## Your Task (Specialist Investigation)

      As a specialist, provide domain-specific analysis:
      1. **Apply your specialized knowledge** to the focus area
      2. **Identify domain-specific concerns** (security, performance, etc.)
      3. **Evaluate against best practices** in your domain
      4. **Provide expert recommendations**

      Provide specialist findings with domain-specific insights.
    output: "specialist_findings"

  - id: "consolidate-findings"
    agent: "amplihack:patterns"
    prompt: |
      Consolidate findings from all parallel deep dives.

      **Investigation Question:** {{investigation_question}}
      **Primary Findings:** {{primary_findings}}
      **Secondary Findings:** {{secondary_findings}}
      **Tertiary Findings:** {{tertiary_findings}}
      **Specialist Findings:** {{specialist_findings}}

      ## Your Task

      1. **Identify connections** between findings from different agents
      2. **Note any contradictions** that need resolution
      3. **Highlight unexpected discoveries** across all explorations
      4. **Create unified understanding** from parallel explorations
      5. **List open questions** for verification phase

      Provide consolidated findings as JSON:
      ```json
      {
        "unified_findings": {
          "key_discoveries": ["major discoveries across all explorations"],
          "code_paths_mapped": ["critical paths identified"],
          "patterns_identified": ["patterns found"],
          "architectural_insights": ["structural understanding"]
        },
        "connections": [
          {
            "finding_a": "from agent A",
            "finding_b": "from agent B",
            "connection": "how they relate"
          }
        ],
        "contradictions": ["any conflicting findings to resolve"],
        "unexpected_discoveries": ["anomalies or surprises"],
        "open_questions": ["questions for verification"],
        "confidence_assessment": "high|medium|low"
      }
      ```
    output: "consolidated_findings"
    parse_json: true

  # ==========================================================================
  # PHASE 4: VERIFICATION & TESTING
  # Hypothesis-based verification with practical tests
  # Uses: analyzer (verification), reviewer (validation)
  # ==========================================================================
  - id: "formulate-hypotheses"
    agent: "amplihack:analyzer"
    prompt: |
      Formulate hypotheses based on the consolidated findings.

      **Investigation Question:** {{investigation_question}}
      **Scope:** {{scope}}
      **Consolidated Findings:** {{consolidated_findings}}

      ## Your Task

      For each key discovery, create a testable hypothesis:
      1. **State the hypothesis clearly**
      2. **Identify evidence that would confirm it**
      3. **Identify evidence that would refute it**
      4. **Design a practical test** to verify

      Provide hypotheses as JSON:
      ```json
      {
        "hypotheses": [
          {
            "id": "H1",
            "statement": "clear hypothesis statement",
            "based_on": "which finding this comes from",
            "confirming_evidence": ["what would confirm this"],
            "refuting_evidence": ["what would refute this"],
            "practical_test": {
              "description": "how to test this",
              "method": "trace_code|examine_logs|test_behavior|verify_config",
              "specific_steps": ["step 1", "step 2"]
            },
            "priority": "high|medium|low"
          }
        ],
        "test_order": ["H1", "H2", "..."]
      }
      ```
    output: "hypotheses"
    parse_json: true

  - id: "execute-verification"
    agent: "amplihack:analyzer"
    prompt: |
      Execute practical verification tests for each hypothesis.

      **Investigation Question:** {{investigation_question}}
      **Hypotheses:** {{hypotheses}}
      **Consolidated Findings:** {{consolidated_findings}}

      ## Verification Methods

      For each hypothesis, execute appropriate verification:
      - **trace_code**: Manually trace code paths, examine actual implementation
      - **examine_logs**: Look at logs, outputs, debug information
      - **test_behavior**: Test edge cases and assumptions
      - **verify_config**: Check configuration effects

      ## Your Task

      1. **Execute each practical test** in priority order
      2. **Document what was tested** with specific files/lines
      3. **Record results** - confirmed, refuted, or inconclusive
      4. **Identify gaps** in understanding
      5. **Refine hypotheses** based on test results

      Provide verification results as JSON:
      ```json
      {
        "verification_results": [
          {
            "hypothesis_id": "H1",
            "test_executed": "description of what was done",
            "evidence_found": ["specific evidence with file:line references"],
            "result": "confirmed|refuted|inconclusive",
            "confidence": "high|medium|low",
            "notes": "observations during verification"
          }
        ],
        "confirmed_understanding": [
          {
            "aspect": "what we now understand",
            "evidence": ["supporting evidence"],
            "confidence": "high|medium|low"
          }
        ],
        "remaining_gaps": ["what's still unclear"],
        "updated_hypotheses": ["any refined hypotheses"],
        "contradictions_resolved": ["how contradictions were resolved"]
      }
      ```
    output: "verification_results"
    parse_json: true

  - id: "validate-verification"
    agent: "amplihack:reviewer"
    prompt: |
      Validate the verification results and overall understanding.

      **Original Question:** {{investigation_question}}
      **Scope:** {{scope}}
      **Verification Results:** {{verification_results}}

      ## Your Task

      1. **Check completeness** - Are all core questions answered?
      2. **Assess evidence quality** - Is the evidence sufficient?
      3. **Identify weak points** - Where is confidence low?
      4. **Recommend additional verification** if needed

      Provide validation as JSON:
      ```json
      {
        "completeness_check": {
          "questions_answered": ["list of answered questions"],
          "questions_unanswered": ["list of unanswered questions"],
          "completeness_score": "0-100%"
        },
        "evidence_quality": {
          "strong_evidence": ["well-supported findings"],
          "weak_evidence": ["findings needing more support"],
          "assumptions_made": ["assumptions in our understanding"]
        },
        "ready_for_synthesis": true|false,
        "additional_verification_needed": ["what else to verify if not ready"]
      }
      ```
    output: "verification_validation"
    parse_json: true

  # ==========================================================================
  # PHASE 5: SYNTHESIS
  # Compile findings into 5 required outputs
  # Uses: reviewer (completeness), patterns (patterns), architect (visual aids)
  # ==========================================================================
  - id: "identify-patterns"
    agent: "amplihack:patterns"
    prompt: |
      Identify reusable patterns discovered during this investigation.

      **Investigation Question:** {{investigation_question}}
      **Consolidated Findings:** {{consolidated_findings}}
      **Verification Results:** {{verification_results}}

      ## Your Task

      1. **Identify reusable patterns** discovered
      2. **Note anti-patterns** observed
      3. **Extract generalizable insights**
      4. **Prepare patterns for PATTERNS.md update**

      Provide patterns as JSON:
      ```json
      {
        "patterns_discovered": [
          {
            "name": "pattern name",
            "description": "what the pattern is",
            "context": "when to use it",
            "example": "where we found it",
            "benefits": ["why it's useful"],
            "add_to_patterns_md": true|false
          }
        ],
        "anti_patterns_observed": [
          {
            "name": "anti-pattern name",
            "description": "what to avoid",
            "why_problematic": "explanation",
            "better_alternative": "what to do instead"
          }
        ],
        "generalizable_insights": ["insights applicable beyond this investigation"]
      }
      ```
    output: "patterns_analysis"
    parse_json: true

  - id: "synthesis"
    agent: "amplihack:architect"
    prompt: |
      Synthesize all findings into the 5 REQUIRED outputs.

      **Original Question:** {{investigation_question}}
      **Scope:** {{scope}}
      **Consolidated Findings:** {{consolidated_findings}}
      **Verification Results:** {{verification_results}}
      **Verification Validation:** {{verification_validation}}
      **Patterns Analysis:** {{patterns_analysis}}

      ## CRITICAL: Generate ALL 5 Synthesis Outputs

      ### Output 1: Executive Summary
      2-3 sentence answer to the main investigation question.
      Clear, concise, suitable for quick understanding.

      ### Output 2: Detailed Explanation
      Complete technical explanation with:
      - Full technical depth
      - Supporting evidence with file:line references
      - Code flow descriptions
      - Component interactions

      ### Output 3: Visual Aids
      Text-based diagrams showing:
      - System flow diagrams (using ASCII or Mermaid)
      - Architecture diagrams
      - Data flow charts
      - Component relationships

      ### Output 4: Key Insights
      Bulleted list of:
      - Non-obvious discoveries
      - Important patterns found
      - Critical understanding points
      - Things that weren't expected

      ### Output 5: Remaining Unknowns
      Honest assessment of:
      - What's still unclear
      - Gaps in understanding
      - Areas needing further investigation
      - Assumptions we're making

      Provide complete synthesis as JSON:
      ```json
      {
        "executive_summary": "2-3 sentence answer to the main question",
        "detailed_explanation": "Complete technical explanation with full depth...",
        "visual_aids": {
          "diagrams": ["```mermaid or ASCII diagram```"],
          "flow_charts": ["flow descriptions"],
          "architecture_views": ["architectural diagrams"]
        },
        "key_insights": [
          "Non-obvious discovery 1",
          "Important pattern 2",
          "Critical understanding point 3"
        ],
        "remaining_unknowns": [
          "What's still unclear",
          "Gaps identified",
          "Areas for future investigation"
        ],
        "recommendations": ["suggestions for next steps or improvements"]
      }
      ```
    output: "synthesis"
    parse_json: true

  - id: "validate-synthesis"
    agent: "amplihack:reviewer"
    prompt: |
      Validate the synthesis addresses all original questions.

      **Original Scope:** {{scope}}
      **Synthesis:** {{synthesis}}

      ## Your Task

      For each core question in the scope:
      1. Is it answered in the synthesis?
      2. Is the answer supported by evidence?
      3. Is the explanation clear?

      Provide validation as JSON:
      ```json
      {
        "questions_coverage": [
          {
            "question": "original question",
            "answered": true|false,
            "answer_location": "where in synthesis",
            "evidence_quality": "strong|adequate|weak"
          }
        ],
        "overall_quality": "excellent|good|adequate|needs_improvement",
        "synthesis_approved": true|false,
        "improvement_suggestions": ["if not approved, what to improve"]
      }
      ```
    output: "synthesis_validation"
    parse_json: true

  # ==========================================================================
  # PHASE 6: KNOWLEDGE CAPTURE
  # Update DISCOVERIES.md, PATTERNS.md, create investigation report
  # ==========================================================================
  - id: "update-discoveries"
    type: "bash"
    command: |
      # Create output directory if needed
      mkdir -p "{{output_dir}}"
      
      # Output status - actual file updates handled by synthesis agent
      echo '{"discoveries_updated": true, "output_dir": "{{output_dir}}", "investigation_question": "{{investigation_question}}", "investigation_type": "{{investigation_type}}"}'
    output: "discoveries_update"
    parse_json: true

  - id: "update-patterns"
    type: "bash"
    condition: "{{patterns_analysis.patterns_discovered}}"
    command: |
      # Output status - actual file updates handled by synthesis agent
      echo '{"patterns_updated": true, "patterns_path": "{{patterns_path}}", "investigation_type": "{{investigation_type}}"}'
    output: "patterns_update"
    parse_json: true

  - id: "create-investigation-report"
    type: "bash"
    command: |
      # Create output directory
      mkdir -p "{{output_dir}}"
      
      # Output report metadata - actual report generation handled by synthesis agent
      echo '{"report_path": "{{output_dir}}/investigation_report.md", "status": "created", "investigation_question": "{{investigation_question}}", "investigation_type": "{{investigation_type}}", "depth": "{{depth}}"}'
    output: "report_creation"
    parse_json: true

  # ==========================================================================
  # TRANSITION GUIDANCE
  # Provide guidance for transitioning to DEFAULT_WORKFLOW if needed
  # ==========================================================================
  - id: "transition-guidance"
    agent: "amplihack:patterns"
    prompt: |
      Analyze whether this investigation should transition to implementation.

      **Investigation Question:** {{investigation_question}}
      **Synthesis:** {{synthesis}}
      **Recommendations:** {{synthesis.recommendations}}

      ## Your Task

      Determine if and how to transition to DEFAULT_WORKFLOW:

      1. **Does this investigation reveal implementation needs?**
      2. **If transitioning, at which step should DEFAULT_WORKFLOW resume?**
         - Step 4 (Research and Design) - if design guidance is needed
         - Step 5 (Implementation) - if design is clear from investigation
      3. **What knowledge from this investigation should inform the implementation?**

      Provide transition guidance as JSON:
      ```json
      {
        "transition_recommended": true|false,
        "reason": "why transition is or isn't recommended",
        "implementation_needs_identified": ["list of implementation tasks revealed"],
        "resume_at_step": "Step 4: Research and Design" | "Step 5: Implementation" | null,
        "knowledge_to_carry_forward": [
          {
            "insight": "key insight",
            "applies_to": "which implementation aspect"
          }
        ],
        "suggested_next_action": "specific next action to take"
      }
      ```
    output: "transition_guidance"
    parse_json: true

  # ==========================================================================
  # EFFICIENCY METRICS
  # Track and report efficiency vs ad-hoc investigation
  # Target: 30-40% message reduction
  # ==========================================================================
  - id: "efficiency-report"
    type: "bash"
    command: |
      START_TIME='{{tracking.start_time}}'
      END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

      # Calculate steps completed (each agent call = ~1-2 messages in ad-hoc)
      # This workflow uses ~15 structured steps vs estimated 40-60 ad-hoc messages
      WORKFLOW_STEPS=15
      ESTIMATED_ADHOC_MESSAGES=55
      EFFICIENCY_GAIN=$(echo "scale=0; 100 - ($WORKFLOW_STEPS * 100 / $ESTIMATED_ADHOC_MESSAGES)" | bc)

      cat << EOF
      {
        "start_time": "$START_TIME",
        "end_time": "$END_TIME",
        "workflow_steps": $WORKFLOW_STEPS,
        "estimated_adhoc_messages": $ESTIMATED_ADHOC_MESSAGES,
        "efficiency_gain_percent": $EFFICIENCY_GAIN,
        "target_met": $([ $EFFICIENCY_GAIN -ge 30 ] && echo "true" || echo "false"),
        "efficiency_sources": [
          "Scope definition prevented scope creep",
          "Exploration strategy prevented random exploration",
          "Parallel deep dives maximized information gathering",
          "Hypothesis verification caught misunderstandings early",
          "Synthesis ensured all questions answered",
          "Knowledge capture prevents repeat investigations"
        ]
      }
      EOF
    output: "efficiency_metrics"
    parse_json: true

  # ==========================================================================
  # FINAL OUTPUT
  # ==========================================================================
  - id: "final-output"
    type: "bash"
    parse_json: true
    command: |
      cat << 'EOF'
      {
        "workflow": "investigation-workflow",
        "version": "2.0.0",
        "question": "{{investigation_question}}",
        "investigation_type": "{{investigation_type}}",
        "status": "complete",
        "phases_completed": 6,
        "phases": [
          "1. Scope Definition",
          "2. Exploration Strategy",
          "3. Parallel Deep Dives",
          "4. Verification & Testing",
          "5. Synthesis (5 outputs)",
          "6. Knowledge Capture"
        ],
        "outputs": {
          "report": "{{output_dir}}/investigation_report.md",
          "discoveries_updated": "{{discoveries_path}}",
          "patterns_updated": "{{patterns_path}}"
        },
        "synthesis_summary": {
          "executive_summary": "{{synthesis.executive_summary}}",
          "key_insights_count": "{{synthesis.key_insights.length}}",
          "remaining_unknowns_count": "{{synthesis.remaining_unknowns.length}}"
        },
        "transition": {
          "recommended": "{{transition_guidance.transition_recommended}}",
          "resume_at": "{{transition_guidance.resume_at_step}}"
        },
        "efficiency": {
          "gain_percent": "{{efficiency_metrics.efficiency_gain_percent}}",
          "target_met": "{{efficiency_metrics.target_met}}"
        }
      }
      EOF
    output: "final_result"
